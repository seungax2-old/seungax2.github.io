<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8"/>
        <script type="text/javascript" src="js/depth-camera.js"></script>
    </head>
    <body onload="main()">
        <div>
            <video id="video" src="" controls="true"/>
        </div>
        <div>
            <!--rgb 데이터-->
            <canvas id="c1" width="160" height="96"></canvas>
            <!--d 데이터-->
            <canvas id="c2" width="640" height="480"></canvas>
        </div>
    </body>

    <script>
        function doLoad() {
            this.video = document.getElementById('video');

            this.c1 = document.getElementById('c1');
            this.c2 = document.getElementById('c2');

            this.ctx_rgb = this.c1.getContext('2d');
            this.ctx_d = this.c2.getContext('2d');

            let self = this;
            this.video.addEventListener('play', function() {
                self.width = self.video.videoWidth / 2;
                self.height = self.video.videoHeight / 2;
                self.computeFrame();
            }, false);
        }
       let frameNo = 1;
        function computeFrame() {
            let rgbArray = new Array();
            if (this.video.paused || this.video.ended) {
                return;
            }else{
                this.ctx_rgb.drawImage(this.video, 0, 0, this.width, this.height);
                //각 픽셀에 대한 이미지 데이터(rgb 값 반환)
                let frame = this.ctx_rgb.getImageData(0, 0, this.width, this.height);
                let l = frame.data.length / 4;

                let frameOj = new Object();
                frameOj.frameNo = frameNo;
                let rgbdata = new Array();
                for (let i = 0; i < l; i++) {
                    let r = frame.data[i * 4 + 0];
                    let g = frame.data[i * 4 + 1];
                    let b = frame.data[i * 4 + 2];
                    let rgb = {r:r , g:g, b:b};
                    rgbdata.push(rgb);
                }
                frameOj.rgbData = rgbdata;
                rgbArray.push(frameOj);

                console.log(rgbArray);
                frameNo++;
                window.requestAnimationFrame(computeFrame);
            }
        }

        async function setupCamera() {
            var depth_stream = await DepthCamera.getDepthStream();
            var color_stream = await DepthCamera.getColorStreamForDepthStream(depth_stream);
            var video = document.getElementById("video");
            video.srcObject = color_stream;
            var parameters = DepthCamera.getCameraCalibration(depth_stream);
            return parameters;
        }
        async function main() {
            "use strict";
            //캘리브레이션
            var cameraParameters = await setupCamera();
            doLoad();
        }

    </script>
</html>
